// Comprehensive Data Migration to Firestore
require('dotenv').config({ path: '../.env' });
const admin = require('firebase-admin');

console.log('üöÄ Starting comprehensive data migration to Firestore...');

// Initialize Firebase
if (!admin.apps.length) {
    const serviceAccount = {
        projectId: process.env.FIREBASE_PROJECT_ID,
        clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
        privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n')
    };

    admin.initializeApp({
        credential: admin.credential.cert(serviceAccount),
        projectId: process.env.FIREBASE_PROJECT_ID
    });
}

const db = admin.firestore();

// Enhanced Users Data
const users = [
    {
        id: 'user1',
        email: 'admin@factcheck.com',
        displayName: 'Dr. Nguy·ªÖn VƒÉn A',
        firstName: 'Nguy·ªÖn VƒÉn',
        lastName: 'A',
        isVerified: true,
        authProvider: 'backend',
        bio: 'Chuy√™n gia y t·∫ø, b√°c sƒ© ƒëa khoa v·ªõi 15 nƒÉm kinh nghi·ªám',
        avatarUrl: 'https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=100',
        role: 'expert',
        stats: { linksChecked: 45, chatMessages: 120, postsCreated: 8 },
        specialization: 'medical',
        createdAt: admin.firestore.Timestamp.now(),
        lastLoginAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'user2',
        email: 'security@factcheck.com',
        displayName: 'Tr·∫ßn Th·ªã B',
        firstName: 'Tr·∫ßn Th·ªã',
        lastName: 'B',
        isVerified: true,
        authProvider: 'firebase',
        bio: 'Chuy√™n gia b·∫£o m·∫≠t m·∫°ng, ph√°t hi·ªán v√† ngƒÉn ch·∫∑n l·ª´a ƒë·∫£o tr·ª±c tuy·∫øn',
        avatarUrl: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=100',
        role: 'security_expert',
        stats: { linksChecked: 67, chatMessages: 89, postsCreated: 12 },
        specialization: 'cybersecurity',
        createdAt: admin.firestore.Timestamp.now(),
        lastLoginAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'user3',
        email: 'tech@factcheck.com',
        displayName: 'L√™ VƒÉn C',
        firstName: 'L√™ VƒÉn',
        lastName: 'C',
        isVerified: true,
        authProvider: 'firebase',
        bio: 'Chuy√™n gia c√¥ng ngh·ªá, ph√¢n t√≠ch ·ª©ng d·ª•ng v√† website ƒë·ªôc h·∫°i',
        avatarUrl: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100',
        role: 'tech_expert',
        stats: { linksChecked: 34, chatMessages: 56, postsCreated: 6 },
        specialization: 'technology',
        createdAt: admin.firestore.Timestamp.now(),
        lastLoginAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'user4',
        email: 'community@factcheck.com',
        displayName: 'Ph·∫°m Th·ªã D',
        firstName: 'Ph·∫°m Th·ªã',
        lastName: 'D',
        isVerified: false,
        authProvider: 'firebase',
        bio: 'Th√†nh vi√™n c·ªông ƒë·ªìng t√≠ch c·ª±c, chia s·∫ª th√¥ng tin h·ªØu √≠ch',
        avatarUrl: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100',
        role: 'community',
        stats: { linksChecked: 23, chatMessages: 45, postsCreated: 4 },
        specialization: 'general',
        createdAt: admin.firestore.Timestamp.now(),
        lastLoginAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'user5',
        email: 'vnexpress@factcheck.com',
        displayName: 'VnExpress',
        firstName: 'VnExpress',
        lastName: 'News',
        isVerified: true,
        authProvider: 'backend',
        bio: 'Trang tin t·ª©c h√†ng ƒë·∫ßu Vi·ªát Nam, cung c·∫•p th√¥ng tin ch√≠nh x√°c v√† k·ªãp th·ªùi',
        avatarUrl: 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=100',
        role: 'media',
        stats: { linksChecked: 156, chatMessages: 12, postsCreated: 45 },
        specialization: 'journalism',
        createdAt: admin.firestore.Timestamp.now(),
        lastLoginAt: admin.firestore.Timestamp.now()
    }
];

// Enhanced Community Posts
const posts = [
    {
        id: 'post1',
        url: 'https://example.com/covid-vaccine-misinformation',
        title: 'C·∫£nh b√°o: Tin gi·∫£ v·ªÅ vaccine COVID-19 lan truy·ªÅn tr√™n m·∫°ng x√£ h·ªôi',
        description: 'C√°c chuy√™n gia y t·∫ø c·∫£nh b√°o v·ªÅ vi·ªác lan truy·ªÅn th√¥ng tin sai l·ªách v·ªÅ vaccine COVID-19. Nh·ªØng tin ƒë·ªìn n√†y c√≥ th·ªÉ g√¢y nguy hi·ªÉm cho s·ª©c kh·ªèe c·ªông ƒë·ªìng.',
        status: 'safe',
        category: 'health',
        submittedBy: 'user1',
        scanResults: {
            virusTotal: { positives: 0, total: 70, scanDate: new Date().toISOString() },
            sslCheck: { valid: true, issuer: 'Let\'s Encrypt', expiryDate: '2025-12-31' },
            domainAge: { years: 5, trustScore: 85 },
            contentAnalysis: { factChecked: true, sources: ['WHO', 'CDC'] }
        },
        imageUrl: 'https://images.unsplash.com/photo-1584118624012-df056829fbd0?w=400',
        tags: ['covid-19', 'vaccine', 'y-te', 'tin-gia'],
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 2 * 60 * 60 * 1000)),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'post2',
        url: 'https://suspicious-bank-site.com',
        title: 'Ph√°t hi·ªán website gi·∫£ m·∫°o ng√¢n h√†ng l·ª´a ƒë·∫£o',
        description: 'Website gi·∫£ m·∫°o Vietcombank v·ªõi domain t∆∞∆°ng t·ª± ƒëang l·ª´a ƒë·∫£o ng∆∞·ªùi d√πng. C·∫£nh b√°o m·ªçi ng∆∞·ªùi kh√¥ng truy c·∫≠p v√† cung c·∫•p th√¥ng tin.',
        status: 'unsafe',
        category: 'security',
        submittedBy: 'user2',
        scanResults: {
            virusTotal: { positives: 25, total: 70, scanDate: new Date().toISOString() },
            sslCheck: { valid: false, error: 'Certificate mismatch' },
            domainAge: { days: 15, trustScore: 5 },
            contentAnalysis: { phishing: true, similarity: 95 }
        },
        imageUrl: 'https://images.unsplash.com/photo-1563013544-824ae1b704d3?w=400',
        tags: ['ngan-hang', 'lua-dao', 'website-gia', 'bao-mat'],
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 4 * 60 * 60 * 1000)),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'post3',
        url: 'https://legitimate-news-source.com/climate-change',
        title: 'Nghi√™n c·ª©u m·ªõi v·ªÅ bi·∫øn ƒë·ªïi kh√≠ h·∫≠u t·ª´ NASA',
        description: 'NASA c√¥ng b·ªë nghi√™n c·ª©u m·ªõi v·ªÅ t√°c ƒë·ªông c·ªßa bi·∫øn ƒë·ªïi kh√≠ h·∫≠u ƒë·∫øn h·ªá sinh th√°i to√†n c·∫ßu. D·ªØ li·ªáu ƒë∆∞·ª£c thu th·∫≠p t·ª´ v·ªá tinh trong 10 nƒÉm qua.',
        status: 'safe',
        category: 'science',
        submittedBy: 'user3',
        scanResults: {
            virusTotal: { positives: 0, total: 70, scanDate: new Date().toISOString() },
            sslCheck: { valid: true, issuer: 'DigiCert', expiryDate: '2025-08-15' },
            domainAge: { years: 12, trustScore: 95 },
            contentAnalysis: { factChecked: true, sources: ['NASA', 'NOAA'] }
        },
        imageUrl: 'https://images.unsplash.com/photo-1611273426858-450d8e3c9fce?w=400',
        tags: ['khoa-hoc', 'nasa', 'khi-hau', 'nghien-cuu'],
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 6 * 60 * 60 * 1000)),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'post4',
        url: 'https://fake-crypto-investment.scam',
        title: 'C·∫£nh b√°o: S√†n giao d·ªãch ti·ªÅn ƒëi·ªán t·ª≠ gi·∫£ m·∫°o',
        description: 'Ph√°t hi·ªán s√†n giao d·ªãch ti·ªÅn ƒëi·ªán t·ª≠ gi·∫£ m·∫°o h·ª©a h·∫πn l·ª£i nhu·∫≠n cao. ƒê√£ c√≥ nhi·ªÅu ng∆∞·ªùi b·ªã l·ª´a m·∫•t ti·ªÅn.',
        status: 'unsafe',
        category: 'finance',
        submittedBy: 'user2',
        scanResults: {
            virusTotal: { positives: 18, total: 70, scanDate: new Date().toISOString() },
            sslCheck: { valid: false, error: 'Self-signed certificate' },
            domainAge: { days: 7, trustScore: 2 },
            contentAnalysis: { scam: true, ponziScheme: true }
        },
        imageUrl: 'https://images.unsplash.com/photo-1621761191319-c6fb62004040?w=400',
        tags: ['tien-dien-tu', 'lua-dao', 'dau-tu', 'san-giao-dich'],
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 8 * 60 * 60 * 1000)),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'post5',
        url: 'https://vnexpress.net/fake-wallet-apps-warning',
        title: 'C·∫£nh b√°o ·ª©ng d·ª•ng gi·∫£ m·∫°o v√≠ ƒëi·ªán t·ª≠ tr√™n CH Play',
        description: 'Google ƒë√£ g·ª° b·ªè h√†ng ch·ª•c ·ª©ng d·ª•ng gi·∫£ m·∫°o c√°c v√≠ ƒëi·ªán t·ª≠ ph·ªï bi·∫øn t·∫°i Vi·ªát Nam. Ng∆∞·ªùi d√πng c·∫ßn c·∫©n th·∫≠n khi t·∫£i ·ª©ng d·ª•ng.',
        status: 'safe',
        category: 'technology',
        submittedBy: 'user5',
        scanResults: {
            virusTotal: { positives: 0, total: 70, scanDate: new Date().toISOString() },
            sslCheck: { valid: true, issuer: 'CloudFlare', expiryDate: '2025-10-20' },
            domainAge: { years: 8, trustScore: 92 },
            contentAnalysis: { factChecked: true, sources: ['Google', 'VnExpress'] }
        },
        imageUrl: 'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=400',
        tags: ['vi-dien-tu', 'ung-dung-gia', 'ch-play', 'bao-mat'],
        createdAt: admin.firestore.Timestamp.fromDate(new Date(Date.now() - 12 * 60 * 60 * 1000)),
        updatedAt: admin.firestore.Timestamp.now()
    }
];

// Votes data
const votes = [
    { id: 'vote1', linkId: 'post1', userId: 'user2', voteType: 'safe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote2', linkId: 'post1', userId: 'user3', voteType: 'safe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote3', linkId: 'post1', userId: 'user4', voteType: 'safe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote4', linkId: 'post2', userId: 'user1', voteType: 'unsafe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote5', linkId: 'post2', userId: 'user3', voteType: 'unsafe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote6', linkId: 'post2', userId: 'user4', voteType: 'unsafe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote7', linkId: 'post3', userId: 'user1', voteType: 'safe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote8', linkId: 'post3', userId: 'user2', voteType: 'safe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote9', linkId: 'post4', userId: 'user1', voteType: 'unsafe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote10', linkId: 'post4', userId: 'user3', voteType: 'unsafe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote11', linkId: 'post5', userId: 'user1', voteType: 'safe', createdAt: admin.firestore.Timestamp.now() },
    { id: 'vote12', linkId: 'post5', userId: 'user2', voteType: 'safe', createdAt: admin.firestore.Timestamp.now() }
];

// Comments data
const comments = [
    {
        id: 'comment1',
        linkId: 'post1',
        userId: 'user2',
        content: 'C·∫£m ∆°n b√°c sƒ© ƒë√£ chia s·∫ª th√¥ng tin ch√≠nh x√°c v·ªÅ vaccine. R·∫•t h·ªØu √≠ch!',
        createdAt: admin.firestore.Timestamp.now(),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'comment2',
        linkId: 'post2',
        userId: 'user1',
        content: 'T√¥i c≈©ng t·ª´ng g·∫∑p website n√†y. R·∫•t nguy hi·ªÉm, m·ªçi ng∆∞·ªùi c·∫©n th·∫≠n!',
        createdAt: admin.firestore.Timestamp.now(),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'comment3',
        linkId: 'post3',
        userId: 'user4',
        content: 'Nghi√™n c·ª©u t·ª´ NASA lu√¥n ƒë√°ng tin c·∫≠y. C·∫£m ∆°n ƒë√£ chia s·∫ª!',
        createdAt: admin.firestore.Timestamp.now(),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'comment4',
        linkId: 'post4',
        userId: 'user3',
        content: 'ƒê√£ b√°o c√°o website n√†y cho c∆° quan ch·ª©c nƒÉng. M·ªçi ng∆∞·ªùi tr√°nh xa!',
        createdAt: admin.firestore.Timestamp.now(),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'comment5',
        linkId: 'post5',
        userId: 'user4',
        content: 'VnExpress lu√¥n c·∫≠p nh·∫≠t tin t·ª©c b·∫£o m·∫≠t k·ªãp th·ªùi. C·∫£m ∆°n!',
        createdAt: admin.firestore.Timestamp.now(),
        updatedAt: admin.firestore.Timestamp.now()
    }
];

// Conversations data
const conversations = [
    {
        id: 'conv1',
        userId: 'user1',
        title: 'C√°ch nh·∫≠n bi·∫øt email l·ª´a ƒë·∫£o',
        createdAt: admin.firestore.Timestamp.now(),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'conv2',
        userId: 'user2',
        title: 'B·∫£o m·∫≠t th√¥ng tin c√° nh√¢n',
        createdAt: admin.firestore.Timestamp.now(),
        updatedAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'conv3',
        userId: 'user3',
        title: 'Ph√¢n t√≠ch website ƒë·ªôc h·∫°i',
        createdAt: admin.firestore.Timestamp.now(),
        updatedAt: admin.firestore.Timestamp.now()
    }
];

// Chat messages data
const chatMessages = [
    {
        id: 'msg1',
        conversationId: 'conv1',
        userId: 'user1',
        content: 'L√†m th·∫ø n√†o ƒë·ªÉ nh·∫≠n bi·∫øt email l·ª´a ƒë·∫£o?',
        role: 'user',
        createdAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'msg2',
        conversationId: 'conv1',
        userId: 'user1',
        content: 'ƒê·ªÉ nh·∫≠n bi·∫øt email l·ª´a ƒë·∫£o, b·∫°n c·∫ßn ch√∫ √Ω:\n\n1. **Ki·ªÉm tra ƒë·ªãa ch·ªâ g·ª≠i**: Email l·ª´a ƒë·∫£o th∆∞·ªùng c√≥ ƒë·ªãa ch·ªâ g·ª≠i l·∫° ho·∫∑c gi·∫£ m·∫°o\n2. **N·ªôi dung kh·∫©n c·∫•p**: Th∆∞·ªùng t·∫°o c·∫£m gi√°c kh·∫©n c·∫•p, y√™u c·∫ßu h√†nh ƒë·ªông ngay\n3. **Li√™n k·∫øt ƒë√°ng ng·ªù**: Hover chu·ªôt ƒë·ªÉ xem URL th·ª±c t·∫ø\n4. **Y√™u c·∫ßu th√¥ng tin**: Kh√¥ng bao gi·ªù cung c·∫•p m·∫≠t kh·∫©u qua email\n5. **L·ªói ch√≠nh t·∫£**: Email l·ª´a ƒë·∫£o th∆∞·ªùng c√≥ nhi·ªÅu l·ªói ng·ªØ ph√°p',
        role: 'assistant',
        createdAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'msg3',
        conversationId: 'conv2',
        userId: 'user2',
        content: 'C√°ch b·∫£o v·ªá th√¥ng tin c√° nh√¢n tr√™n m·∫°ng?',
        role: 'user',
        createdAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'msg4',
        conversationId: 'conv2',
        userId: 'user2',
        content: 'ƒê·ªÉ b·∫£o v·ªá th√¥ng tin c√° nh√¢n:\n\nüîê **M·∫≠t kh·∫©u m·∫°nh**:\n- T·ªëi thi·ªÉu 12 k√Ω t·ª±\n- K·∫øt h·ª£p ch·ªØ hoa, th∆∞·ªùng, s·ªë, k√Ω t·ª± ƒë·∫∑c bi·ªát\n- S·ª≠ d·ª•ng password manager\n\nüõ°Ô∏è **X√°c th·ª±c 2 y·∫øu t·ªë (2FA)**:\n- B·∫≠t 2FA cho t·∫•t c·∫£ t√†i kho·∫£n quan tr·ªçng\n- S·ª≠ d·ª•ng app authenticator thay v√¨ SMS\n\nüåê **Duy·ªát web an to√†n**:\n- Ch·ªâ truy c·∫≠p website HTTPS\n- Kh√¥ng click link l·∫°\n- S·ª≠ d·ª•ng VPN khi c·∫ßn',
        role: 'assistant',
        createdAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'msg5',
        conversationId: 'conv3',
        userId: 'user3',
        content: 'L√†m sao ph√¢n t√≠ch m·ªôt website c√≥ ƒë·ªôc h·∫°i kh√¥ng?',
        role: 'user',
        createdAt: admin.firestore.Timestamp.now()
    },
    {
        id: 'msg6',
        conversationId: 'conv3',
        userId: 'user3',
        content: 'ƒê·ªÉ ph√¢n t√≠ch website ƒë·ªôc h·∫°i:\n\nüîç **Ki·ªÉm tra URL**:\n- Domain c√≥ ch√≠nh t·∫£ ƒë√∫ng kh√¥ng\n- C√≥ HTTPS kh√¥ng\n- Tu·ªïi domain (domain m·ªõi th∆∞·ªùng ƒë√°ng ng·ªù)\n\nüõ°Ô∏è **Scan b·∫£o m·∫≠t**:\n- S·ª≠ d·ª•ng VirusTotal\n- Ki·ªÉm tra certificate SSL\n- Xem reputation score\n\n‚ö†Ô∏è **D·∫•u hi·ªáu c·∫£nh b√°o**:\n- Popup qu√° nhi·ªÅu\n- Y√™u c·∫ßu c√†i ƒë·∫∑t ph·∫ßn m·ªÅm\n- Thi·∫øt k·∫ø k√©m ch·∫•t l∆∞·ª£ng\n- L·ªói ch√≠nh t·∫£ nhi·ªÅu',
        role: 'assistant',
        createdAt: admin.firestore.Timestamp.now()
    }
];

async function migrateData() {
    try {
        console.log('üë• Migrating users...');
        for (const user of users) {
            await db.collection('users').doc(user.id).set(user);
            console.log(`‚úÖ ${user.displayName}`);
        }

        console.log('\nüîó Migrating community posts...');
        for (const post of posts) {
            await db.collection('links').doc(post.id).set(post);
            console.log(`‚úÖ ${post.title.substring(0, 50)}...`);
        }

        console.log('\nüó≥Ô∏è Migrating votes...');
        for (const vote of votes) {
            await db.collection('votes').doc(vote.id).set(vote);
            console.log(`‚úÖ ${vote.id} (${vote.voteType})`);
        }

        console.log('\nüí¨ Migrating comments...');
        for (const comment of comments) {
            await db.collection('comments').doc(comment.id).set(comment);
            console.log(`‚úÖ ${comment.id}`);
        }

        console.log('\nüó®Ô∏è Migrating conversations...');
        for (const conversation of conversations) {
            await db.collection('conversations').doc(conversation.id).set(conversation);
            console.log(`‚úÖ ${conversation.title}`);
        }

        console.log('\nüìù Migrating chat messages...');
        for (const message of chatMessages) {
            await db.collection('chat_messages').doc(message.id).set(message);
            console.log(`‚úÖ ${message.id}`);
        }

        console.log('\nüéâ Migration completed successfully!');
        console.log('=====================================');
        console.log(`üë• Users: ${users.length}`);
        console.log(`üîó Community Posts: ${posts.length}`);
        console.log(`üó≥Ô∏è Votes: ${votes.length}`);
        console.log(`üí¨ Comments: ${comments.length}`);
        console.log(`üó®Ô∏è Conversations: ${conversations.length}`);
        console.log(`üìù Chat Messages: ${chatMessages.length}`);
        
        const total = users.length + posts.length + votes.length + comments.length + conversations.length + chatMessages.length;
        console.log(`\nüìä Total documents migrated: ${total}`);
        
        console.log('\n‚úÖ All in-memory and mock data has been migrated to Firestore!');
        console.log('üî• Your FactCheck app now has real, persistent data.');

        process.exit(0);
    } catch (error) {
        console.error('‚ùå Migration failed:', error);
        process.exit(1);
    }
}

migrateData();
